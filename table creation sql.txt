CREATE TABLE IF NOT EXISTS "user" (
    player_id uuid PRIMARY KEY NOT NULL UNIQUE,
    nick varchar(64),
    email varchar(320),
    pass varchar(64),
    account_created date
);

CREATE TABLE IF NOT EXISTS facebook_login (
    player_id uuid REFERENCES "user" (player_id) NOT NULL UNIQUE,
    access_token varchar(256),
    expires_in bigint,
    signed_request varchar(256),
    user_id varchar(256)
);

CREATE TABLE IF NOT EXISTS google_login (
    player_id uuid REFERENCES "user" (player_id) NOT NULL UNIQUE,
    real_name varchar(128),
    icon_url text,
    jwt_issuer varchar(256),
    google_account_id bigint,
    azp varchar(256),
    client_id varchar(256),
    token_creation_date bigint,
    token_expiration_date bigint
);

CREATE TABLE IF NOT EXISTS chat (
    chat_id uuid PRIMARY KEY NOT NULL UNIQUE,
    player_id uuid REFERENCES "user" (player_id) NOT NULL,
    other_side uuid REFERENCES "user" (player_id) NOT NULL
);

CREATE TABLE IF NOT EXISTS message (
    chat_id uuid REFERENCES chat (chat_id) NOT NULL,
    time_sent timestamp NOT NULL,
    message_body varchar(256)
);

CREATE TABLE IF NOT EXISTS clan (
    clan_id uuid PRIMARY KEY NOT NULL UNIQUE,
    creator_id uuid REFERENCES "user" (player_id) NOT NULL UNIQUE,
    name varchar(64),
    roles text
);

CREATE TABLE IF NOT EXISTS clan_member (
    clan_id uuid REFERENCES clan (clan_id) NOT NULL,
    player_id uuid REFERENCES "user" (player_id) NOT NULL UNIQUE,
    role varchar(32)
);

CREATE TABLE IF NOT EXISTS clan_chat (
    chat_id uuid PRIMARY KEY NOT NULL UNIQUE,
    player_id uuid REFERENCES "user" (player_id) NOT NULL,
    clan_id uuid REFERENCES clan (clan_id) NOT NULL
);

CREATE TABLE IF NOT EXISTS clan_message (
    chat_id uuid REFERENCES clan_chat (chat_id) NOT NULL,
    time_sent timestamp NOT NULL,
    message_body varchar(256)
);

CREATE TABLE IF NOT EXISTS contact (
    player_id uuid REFERENCES "user" (player_id) NOT NULL,
    contact_id uuid REFERENCES "user" (player_id) NOT NULL,
    status varchar(16)
);

CREATE TABLE IF NOT EXISTS class (
    class_id uuid PRIMARY KEY UNIQUE NOT NULL,
    name varchar(32),
    base_health int,
    health_scaling int,
    base_health_regen int,
    health_regen_scaling int,
    base_attack int,
    attack_scaling int,
    base_defense int,
    defense_scaling int,
    base_mana int,
    mana_scaling int,
    mana_regen int,
    mana_regen_scaling int
);

CREATE TABLE IF NOT EXISTS character (
    character_id uuid PRIMARY KEY UNIQUE NOT NULL,
    player_id uuid REFERENCES "user" (player_id) NOT NULL,
    name varchar(64),
    class_id uuid REFERENCES class (class_id) NOT NULL,
    level int,
    xp bigint,
    xp_next_lvl bigint,
    health int,
    attack int,
    defense int,
    location point
);

CREATE TABLE IF NOT EXISTS ability (
    ability_id uuid PRIMARY KEY UNIQUE NOT NULL,
    class_id uuid REFERENCES class (class_id) NOT NULL,
    name varchar(32),
    unlock_level int,
    damage int,
    damage_scaling int,
    mana_cost int,
    mana_cost_scaling int,
    effect text,
    effect_duration interval
);

CREATE TABLE IF NOT EXISTS storage(
    storage_id uuid PRIMARY KEY NOT NULL UNIQUE,
    character_id uuid REFERENCES character (character_id) NOT NULL,
    name varchar(64),
    size point,
    weight_limit bigint
);

CREATE TABLE IF NOT EXISTS item(
    item_id uuid PRIMARY KEY NOT NULL UNIQUE,
    name varchar(64),
    description varchar(256),
    price money,
    effect varchar(16),
    size int,
    weight bigint
);

CREATE TABLE IF NOT EXISTS item_inventory_instance(
    item_id uuid REFERENCES item(item_id) NOT NULL,
    storage_id uuid REFERENCES storage (storage_id) NOT NULL,
    equipped bool
);

CREATE TABLE IF NOT EXISTS level(
    level_id uuid PRIMARY KEY NOT NULL UNIQUE,
    map text,
    starting_point point,
    end_point point,
    enemy_spawn_points path
);

CREATE TABLE IF NOT EXISTS game(
    game_id uuid PRIMARY KEY UNIQUE NOT NULL,
    character_id uuid REFERENCES character (character_id),
    level_id uuid REFERENCES level (level_id)
);

CREATE TABLE IF NOT EXISTS item_level_instance(
    item_id uuid REFERENCES item (item_id),
    location point
);

CREATE TABLE IF NOT EXISTS quest_givers(
    quest_giver_id uuid PRIMARY KEY UNIQUE NOT NULL,
    name varchar(64),
    level uuid REFERENCES level (level_id),
    location point
);

CREATE TABLE IF NOT EXISTS quest(
    quest_id uuid PRIMARY KEY UNIQUE NOT NULL,
    quest_giver_id uuid REFERENCES quest_givers (quest_giver_id) NOT NULL,
    name varchar(64) NOT NULL,
    description varchar(256) NOT NULL,
    monsters_killed bigint,
    item_found uuid REFERENCES item (item_id),
    character_level int,
    reward json,
    previous_quest uuid REFERENCES quest (quest_id)
);

CREATE TABLE IF NOT EXISTS spawn_conditions(
    sc_id uuid PRIMARY KEY UNIQUE NOT NULL,
    min_player_level int,
    max_player_level int,
    level uuid REFERENCES level (level_id),
    previous_quest uuid REFERENCES quest (quest_id)
);

CREATE TABLE IF NOT EXISTS enemy(
    enemy_id uuid PRIMARY KEY UNIQUE NOT NULL,
    name varchar(64),
    base_health int,
    base_damage int,
    base_defense int,
    base_death_reward json,
    spawn_condition uuid REFERENCES spawn_conditions (sc_id)
);

ALTER TABLE spawn_conditions
ADD COLUMN previous_monster uuid REFERENCES enemy (enemy_id);

CREATE TABLE IF NOT EXISTS enemy_instance(
    enemy_instance_id uuid PRIMARY KEY NOT NULL UNIQUE,
    enemy_id uuid REFERENCES enemy (enemy_id),
    location point,
    health int,
    damage int,
    defense int,
    death_reward json,
    level bigint
);

CREATE TABLE IF NOT EXISTS item_log(
    no uuid PRIMARY KEY UNIQUE NOT NULL,
    item_id uuid REFERENCES item (item_id),
    level_id uuid REFERENCES level (level_id),
    time timestamp DEFAULT now(),
    location point,
    use varchar(16)
);

CREATE TABLE IF NOT EXISTS quest_log(
    no uuid PRIMARY KEY UNIQUE NOT NULL,
    quest_id uuid REFERENCES quest (quest_id),
    quest_started timestamp DEFAULT now(),
    quest_ended timestamp,
    time_taken interval,
    reward json,
    location point
);

CREATE TABLE IF NOT EXISTS damage_taken_log(
    no uuid PRIMARY KEY UNIQUE NOT NULL,
    character_id uuid REFERENCES character (character_id),
    enemy_id uuid REFERENCES enemy (enemy_id),
    damage_base int,
    damage_mitigated int,
    damage_taken int,
    location point,
    time timestamp DEFAULT now()
);

CREATE TABLE IF NOT EXISTS damage_dealt_log(
    no uuid PRIMARY KEY UNIQUE NOT NULL,
    character_id uuid REFERENCES character (character_id),
    enemy_id uuid REFERENCES enemy (enemy_id),
    damage_base int,
    damage_mitigated int,
    damage_taken int,
    location point,
    time timestamp DEFAULT now()
);

CREATE TABLE IF NOT EXISTS kill_log(
    no uuid PRIMARY KEY UNIQUE NOT NULL,
    character_id uuid REFERENCES character (character_id),
    enemy_id uuid REFERENCES enemy (enemy_id),
    last_ability uuid REFERENCES ability (ability_id),
    battle_start timestamp,
    battle_end timestamp DEFAULT now(),
    battle_length interval,
    damage_taken_by_player int,
    damage_dealt_by_player int,
    damage_mitigated_by_player int,
    reward json,
    location point,
    time timestamp DEFAULT now()
);

CREATE TABLE IF NOT EXISTS effect_log(
    no uuid PRIMARY KEY UNIQUE NOT NULL,
    character_id uuid REFERENCES character (character_id),
    enemy_id uuid REFERENCES enemy (enemy_id),
    effect varchar(16),
    effect_duration interval,
    location point,
    time timestamp DEFAULT now()
);